openapi: 3.0.3
info:
  title: ProfZoom OTP Bot API
  version: 1.1.0
  description: >
    OTP_bot delivers OTP codes via Telegram and manages Telegram account linking.
    It MUST NOT generate, store, or verify OTP codes.

tags:
  - name: Health
  - name: OTP
  - name: Telegram

security: []

components:
  securitySchemes:
    InternalKeyHeader:
      type: apiKey
      in: header
      name: X-Internal-Key
      description: >
        Internal service-to-service authentication.
        You can also send Authorization: Bearer <OTP_BOT_INTERNAL_KEY>.

  schemas:
    ErrorResponse:
      type: object
      additionalProperties: false
      required: [error]
      properties:
        error:
          type: string
          description: Machine-readable error code.

    HealthResponse:
      type: object
      additionalProperties: false
      required: [status]
      properties:
        status:
          type: string
          enum: [ok]

    OTPSendRequest:
      type: object
      additionalProperties: false
      required: [phone, code]
      properties:
        phone:
          type: string
          description: Phone number in E.164 format.
        code:
          type: string
          description: OTP code generated by the main backend.

    OTPSendResponse:
      type: object
      additionalProperties: false
      required: [sent]
      properties:
        sent:
          type: boolean
          enum: [true]

    TelegramLinkTokenRequest:
      type: object
      additionalProperties: false
      required: [phone, token]
      properties:
        phone:
          type: string
          description: Phone number in E.164 format.
        token:
          type: string
          description: One-time linking token generated by the main backend.

    TelegramLinkTokenResponse:
      type: object
      additionalProperties: false
      required: [success]
      properties:
        success:
          type: boolean
          enum: [true]

    TelegramStatusResponse:
      type: object
      additionalProperties: false
      required: [linked]
      properties:
        linked:
          type: boolean

    TelegramUpdate:
      type: object
      description: Telegram webhook update object (partial schema).
      additionalProperties: true
      properties:
        update_id:
          type: integer
        message:
          type: object
          additionalProperties: true
          properties:
            message_id:
              type: integer
            text:
              type: string
            chat:
              type: object
              additionalProperties: true
              properties:
                id:
                  type: integer
                  format: int64
                type:
                  type: string

  parameters:
    PhoneQuery:
      name: phone
      in: query
      required: true
      schema:
        type: string
      description: Phone number in canonical form (recommended E.164).

    XTelegramSecret:
      name: X-Telegram-Bot-Api-Secret-Token
      in: header
      required: true
      schema:
        type: string
      description: Telegram webhook secret token configured when setting the webhook.

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /otp/send:
    post:
      tags: [OTP]
      summary: Send OTP code to a Telegram chat (delivery only)
      description: >
        Called by the main backend. OTP_bot must only deliver the provided code.
      security:
        - InternalKeyHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OTPSendRequest"
      responses:
        "200":
          description: OTP successfully delivered to Telegram
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OTPSendResponse"
        "400":
          description: Invalid payload or phone not linked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalid_payload:
                  value: { error: invalid_payload }
                phone_not_linked:
                  value: { error: phone_not_linked }
        "401":
          description: Missing or invalid internal auth key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                unauthorized:
                  value: { error: unauthorized }
        "429":
          description: Rate limited (chat or global)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                rate_limited:
                  value: { error: rate_limited }
        "500":
          description: Internal error or Telegram API failure
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                telegram_failed:
                  value: { error: telegram_failed }
                internal_error:
                  value: { error: internal_error }

  /telegram/link-token:
    post:
      tags: [Telegram]
      summary: Register a Telegram linking token
      description: >
        Called by the main backend to register a token for linking.
        The app should build a Telegram deep link: /start <token>.
      security:
        - InternalKeyHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TelegramLinkTokenRequest"
      responses:
        "200":
          description: Token registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TelegramLinkTokenResponse"
        "400":
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalid_payload:
                  value: { error: invalid_payload }
        "401":
          description: Missing or invalid internal auth key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                unauthorized:
                  value: { error: unauthorized }
        "429":
          description: Rate limited
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                rate_limited:
                  value: { error: rate_limited }
        "500":
          description: Failed to register token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                link_token_failed:
                  value: { error: link_token_failed }

  /telegram/status:
    get:
      tags: [Telegram]
      summary: Get Telegram link status for a phone
      description: >
        Returns whether the phone is linked to a Telegram chat.
        The phone may be provided as a query parameter or as a JSON body.
      security:
        - InternalKeyHeader: []
      parameters:
        - $ref: "#/components/parameters/PhoneQuery"
      responses:
        "200":
          description: Link status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TelegramStatusResponse"
              examples:
                linked:
                  value: { linked: true }
                not_linked:
                  value: { linked: false }
        "400":
          description: Missing phone
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                missing_phone:
                  value: { error: missing_phone }
        "401":
          description: Missing or invalid internal auth key
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                unauthorized:
                  value: { error: unauthorized }
        "500":
          description: Failed to fetch status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                status_failed:
                  value: { error: status_failed }

  /telegram/webhook:
    post:
      tags: [Telegram]
      summary: Telegram webhook endpoint
      description: >
        Receives Telegram updates. Supports /start <token>, /help, /status,
        and contact sharing in private chats. The service validates the
        Telegram secret header when configured.
      parameters:
        - $ref: "#/components/parameters/XTelegramSecret"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TelegramUpdate"
      responses:
        "200":
          description: Update accepted
        "400":
          description: Invalid update payload
        "401":
          description: Invalid or missing Telegram secret
        "405":
          description: Method not allowed
        "500":
          description: Internal handler error
